worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Diccionario compartido para microcaché
    lua_shared_dict microcache 10m;

    # Ruta de módulos Lua
    lua_package_path "/usr/local/openresty/nginx/conf/lua/?.lua;;";

    server {
        listen 80;

        # Directorio raíz para Symfony
        root /app/public;

        # Manejar todas las peticiones con index.php
        location / {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # Procesar PHP con PHP-FPM
        location ~ \.php$ {
            # Usar handler.lua para cachear
            access_by_lua_file /usr/local/openresty/nginx/conf/lua/handler.lua;

            # Proxy a PHP-FPM
            fastcgi_pass php:9000;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
            fastcgi_param DOCUMENT_ROOT /var/www/html/public;
        }

        # Ruta para Symfony (proxy interno)
        location = /proxy_to_backend {
            internal;
            fastcgi_pass php:9000;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        }

        # Ruta de prueba para Lua
        location /test {
            content_by_lua_block {
                ngx.say("Lua está funcionando!")
            }
        }
    }
}
